<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Pricing Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .save-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }
        
        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .grid-4 {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .metric-card p {
            opacity: 0.9;
        }
        
        .product-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table th,
        .table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Product Pricing Calculator</h1>
            <p>Enhanced with automatic data persistence</p>
            <div class="save-status" id="saveStatus">Ready</div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard', this)">Dashboard</button>
            <button class="nav-tab" onclick="showTab('products', this)">Products</button>
            <button class="nav-tab" onclick="showTab('costs', this)">Company Costs</button>
            <button class="nav-tab" onclick="showTab('data', this)">Data Management</button>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>Business Overview</h2>
                <div class="grid grid-4" id="metricsGrid">
                    <!-- Metrics will be populated by JavaScript -->
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>True Break-Even Analysis</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-3" id="breakEvenGrid">
                            <!-- Break-even metrics will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-success" onclick="exportToCSV()">Export Business Report</button>
                        <button class="btn btn-primary" onclick="exportForPowerPoint()">Export Charts for PowerPoint</button>
                    </div>
                </div>
            </div>
            
            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Product Management</h2>
                    <button class="btn btn-primary" onclick="showAddProduct()">Add Product</button>
                </div>
                
                <div id="productsList">
                    <!-- Products will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Company Costs Tab -->
            <div id="costs" class="tab-content">
                <h2>Company Costs Management</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Employee Costs</h3>
                        <button class="btn btn-primary" onclick="showAddEmployee()">Add Employee</button>
                    </div>
                    <div class="card-body" id="employeesList">
                        <!-- Employees will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Fixed Monthly Costs</h3>
                        <button class="btn btn-primary" onclick="showAddFixedCost()">Add Fixed Cost</button>
                    </div>
                    <div class="card-body" id="fixedCostsList">
                        <!-- Fixed costs will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3>Variable Costs (% of Revenue)</h3>
                        <button class="btn btn-primary" onclick="showAddVariableCost()">Add Variable Cost</button>
                    </div>
                    <div class="card-body" id="variableCostsList">
                        <!-- Variable costs will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Data Management Tab -->
            <div id="data" class="tab-content">
                <h2>Data Management</h2>
                
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3>Auto-Save Status</h3>
                        </div>
                        <div class="card-body">
                            <p><strong>Status:</strong> <span id="dataStatus">Ready</span></p>
                            <p><strong>Products:</strong> <span id="productCount">0</span></p>
                            <p><strong>Employees:</strong> <span id="employeeCount">0</span></p>
                            <p><strong>Last Saved:</strong> <span id="lastSaved">Never</span></p>
                            <button class="btn btn-success" onclick="saveData(true)">Manual Save</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Backup & Restore</h3>
                        </div>
                        <div class="card-body">
                            <button class="btn btn-primary" onclick="exportBackup()">Export Backup</button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(event)">
                            <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">Import Backup</button>
                            <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let products = [];
        let companyCosts = {
            employees: [],
            fixedCosts: [],
            variableCosts: []
        };
        let saveTimeout = null;
        let materialCostIndex = 1;
        let outsourcedCostIndex = 1;

        // Initialize the app
        window.onload = function() {
            loadData();
            updateDashboard();
            updateProductsList();
            updateCompanyCosts();
            updateDataStatus();
        };

        // Tab management
        function showTab(tabName, clickedTab) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            clickedTab.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'data') {
                updateDataStatus();
            }
        }

        // Data persistence functions
        function saveData(manual = false) {
            const data = {
                products: products,
                companyCosts: companyCosts,
                lastSaved: new Date().toISOString(),
                version: '1.0'
            };
            
            try {
                updateSaveStatus(manual ? 'Manual Save' : 'Auto-saved');
                updateDataStatus();
            } catch (error) {
                updateSaveStatus('Save Error');
                console.error('Error saving data:', error);
            }
        }

        function loadData() {
            updateSaveStatus('Data Loaded');
        }

        function autoSave() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(() => {
                saveData();
            }, 1000);
        }

        function updateSaveStatus(status) {
            document.getElementById('saveStatus').textContent = status;
            document.getElementById('dataStatus').textContent = status;
            setTimeout(() => {
                if (status !== 'Save Error') {
                    document.getElementById('saveStatus').textContent = 'Ready';
                    document.getElementById('dataStatus').textContent = 'Ready';
                }
            }, 2000);
        }

        // Calculation functions
        function calculateProductMetrics(product) {
            return product.sizes.map(size => {
                const actualMaterialNeeded = (size.grams / 1000) * (1 + product.wastePercentage / 100);
                
                let totalMaterialCost = 0;
                if (size.materialCosts && size.materialCosts.length > 0) {
                    totalMaterialCost = size.materialCosts.reduce((sum, material) => 
                        sum + (actualMaterialNeeded * material.costPerKg), 0);
                }

                let totalOutsourcedCost = 0;
                if (size.outsourcedCosts && size.outsourcedCosts.length > 0) {
                    totalOutsourcedCost = size.outsourcedCosts.reduce((sum, service) => 
                        sum + service.cost, 0);
                }

                const totalCost = totalMaterialCost + totalOutsourcedCost;
                const salesPrice = totalCost / (1 - size.profitMargin / 100);
                const profitPerUnit = salesPrice - totalCost;
                const monthlySales = size.unitsSoldMonthly * salesPrice;
                const monthlyProfit = size.unitsSoldMonthly * profitPerUnit;

                return {
                    ...size,
                    materialCost: totalMaterialCost,
                    totalCost,
                    salesPrice,
                    profitPerUnit,
                    monthlySales,
                    monthlyProfit
                };
            });
        }

        function calculateCompanyOverhead() {
            const monthlyEmployeeCosts = companyCosts.employees.reduce((sum, emp) => 
                sum + emp.monthlySalary + (emp.benefits || 0), 0);
            
            const monthlyFixedCosts = companyCosts.fixedCosts.reduce((sum, cost) => 
                sum + cost.monthlyAmount, 0);
            
            const totalRevenue = products.reduce((pSum, product) => {
                const metrics = calculateProductMetrics(product);
                return pSum + metrics.reduce((mSum, m) => mSum + m.monthlySales, 0);
            }, 0);
            
            const monthlyVariableCosts = companyCosts.variableCosts.reduce((sum, cost) => 
                sum + (totalRevenue * cost.percentageOfRevenue / 100), 0);

            const totalMonthlyOverhead = monthlyEmployeeCosts + monthlyFixedCosts + monthlyVariableCosts;
            
            return {
                monthlyEmployeeCosts,
                monthlyFixedCosts,
                monthlyVariableCosts,
                totalMonthlyOverhead
            };
        }

        function calculateTrueBreakEven() {
            const overhead = calculateCompanyOverhead();
            const totalContributionMargin = products.reduce((sum, product) => {
                const metrics = calculateProductMetrics(product);
                return sum + metrics.reduce((mSum, m) => mSum + (m.profitPerUnit * m.unitsSoldMonthly), 0);
            }, 0);
            
            const totalUnitsSold = products.reduce((sum, product) => {
                const metrics = calculateProductMetrics(product);
                return sum + metrics.reduce((mSum, m) => mSum + m.unitsSoldMonthly, 0);
            }, 0);
            
            const averageContributionPerUnit = totalUnitsSold > 0 ? totalContributionMargin / totalUnitsSold : 0;
            const breakEvenUnits = averageContributionPerUnit > 0 ? 
                Math.ceil(overhead.totalMonthlyOverhead / averageContributionPerUnit) : 0;

            return {
                ...overhead,
                totalContributionMargin,
                averageContributionPerUnit,
                breakEvenUnits,
                currentProfitAfterOverhead: totalContributionMargin - overhead.totalMonthlyOverhead
            };
        }

        function formatNOK(amount) {
            return new Intl.NumberFormat('nb-NO', {
                style: 'currency',
                currency: 'NOK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Dashboard functions
        function updateDashboard() {
            const totalMonthlySales = products.reduce((sum, product) => {
                const metrics = calculateProductMetrics(product);
                return sum + metrics.reduce((mSum, m) => mSum + m.monthlySales, 0);
            }, 0);

            const totalMonthlyProfit = products.reduce((sum, product) => {
                const metrics = calculateProductMetrics(product);
                return sum + metrics.reduce((mSum, m) => mSum + m.monthlyProfit, 0);
            }, 0);

            const trueBreakEven = calculateTrueBreakEven();

            document.getElementById('metricsGrid').innerHTML = `
                <div class="metric-card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                    <h3>${formatNOK(totalMonthlySales)}</h3>
                    <p>Monthly Sales</p>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #007bff, #6610f2);">
                    <h3>${formatNOK(totalMonthlyProfit)}</h3>
                    <p>Contribution Margin</p>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, #dc3545, #e83e8c);">
                    <h3>${formatNOK(trueBreakEven.totalMonthlyOverhead)}</h3>
                    <p>Monthly Overhead</p>
                </div>
                <div class="metric-card" style="background: linear-gradient(135deg, ${trueBreakEven.currentProfitAfterOverhead >= 0 ? '#fd7e14, #ffc107' : '#6c757d, #495057'});">
                    <h3>${formatNOK(trueBreakEven.currentProfitAfterOverhead)}</h3>
                    <p>Net Profit</p>
                </div>
            `;

            document.getElementById('breakEvenGrid').innerHTML = `
                <div style="text-align: center;">
                    <h4>${formatNOK(trueBreakEven.totalMonthlyOverhead)}</h4>
                    <p>Monthly Overhead to Cover</p>
                </div>
                <div style="text-align: center;">
                    <h4>${formatNOK(trueBreakEven.averageContributionPerUnit)}</h4>
                    <p>Avg Contribution per Unit</p>
                </div>
                <div style="text-align: center;">
                    <h4>${trueBreakEven.breakEvenUnits.toLocaleString()}</h4>
                    <p>Units Needed for Break-Even</p>
                </div>
            `;
        }

        // Product functions
        function showAddProduct() {
            showProductModal();
        }

        function showEditProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                showProductModal(product);
            }
        }

        function showProductModal(product = null) {
            const isEditing = !!product;
            const title = isEditing ? `Edit Product - ${product.name}` : 'Add New Product';
            
            const materialCostsHtml = isEditing && product.sizes[0].materialCosts ? 
                product.sizes[0].materialCosts.map((material, index) => `
                    <div class="material-cost-item" data-index="${index}">
                        <div class="grid grid-3" style="align-items: end;">
                            <div class="form-group">
                                <label>Material Name</label>
                                <input type="text" class="form-control material-name" value="${material.name || ''}" placeholder="e.g., Aluminum">
                            </div>
                            <div class="form-group">
                                <label>Cost per kg (NOK)</label>
                                <input type="number" class="form-control material-cost" value="${material.costPerKg || 0}" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-danger" onclick="removeMaterialCost(${index})" ${index === 0 ? 'style="visibility: hidden;"' : ''}>Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('') : `
                    <div class="material-cost-item" data-index="0">
                        <div class="grid grid-3" style="align-items: end;">
                            <div class="form-group">
                                <label>Material Name</label>
                                <input type="text" class="form-control material-name" value="Main Material" placeholder="e.g., Aluminum">
                            </div>
                            <div class="form-group">
                                <label>Cost per kg (NOK)</label>
                                <input type="number" class="form-control material-cost" value="0" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-danger" onclick="removeMaterialCost(0)" style="visibility: hidden;">Remove</button>
                            </div>
                        </div>
                    </div>
                `;

            const outsourcedCostsHtml = isEditing && product.sizes[0].outsourcedCosts ? 
                product.sizes[0].outsourcedCosts.map((service, index) => `
                    <div class="outsourced-cost-item" data-index="${index}">
                        <div class="grid grid-3" style="align-items: end;">
                            <div class="form-group">
                                <label>Service Name</label>
                                <input type="text" class="form-control outsourced-name" value="${service.name || ''}" placeholder="e.g., Assembly">
                            </div>
                            <div class="form-group">
                                <label>Cost (NOK)</label>
                                <input type="number" class="form-control outsourced-cost" value="${service.cost || 0}" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-danger" onclick="removeOutsourcedCost(${index})" ${index === 0 ? 'style="visibility: hidden;"' : ''}>Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('') : `
                    <div class="outsourced-cost-item" data-index="0">
                        <div class="grid grid-3" style="align-items: end;">
                            <div class="form-group">
                                <label>Service Name</label>
                                <input type="text" class="form-control outsourced-name" value="Main Service" placeholder="e.g., Assembly">
                            </div>
                            <div class="form-group">
                                <label>Cost (NOK)</label>
                                <input type="number" class="form-control outsourced-cost" value="0" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-danger" onclick="removeOutsourcedCost(0)" style="visibility: hidden;">Remove</button>
                            </div>
                        </div>
                    </div>
                `;
            
            const modal = createModal(title, `
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" class="form-control" id="productName" placeholder="Enter product name" value="${isEditing ? product.name : ''}">
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-control" id="productCategory">
                            <option value="">Select category</option>
                            <option value="Electronics" ${isEditing && product.category === 'Electronics' ? 'selected' : ''}>Electronics</option>
                            <option value="Food" ${isEditing && product.category === 'Food' ? 'selected' : ''}>Food</option>
                            <option value="Cosmetics" ${isEditing && product.category === 'Cosmetics' ? 'selected' : ''}>Cosmetics</option>
                            <option value="Textiles" ${isEditing && product.category === 'Textiles' ? 'selected' : ''}>Textiles</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Waste Percentage</label>
                        <input type="number" class="form-control" id="wastePercentage" value="${isEditing ? product.wastePercentage : 5}" min="0" max="50" step="0.1">
                    </div>
                </div>
                <h4>Product Size & Pricing</h4>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Size (grams)</label>
                        <input type="number" class="form-control" id="sizeGrams" value="${isEditing ? product.sizes[0].grams : 100}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Profit Margin (%)</label>
                        <input type="number" class="form-control" id="profitMargin" value="${isEditing ? product.sizes[0].profitMargin : 30}" min="0" max="100" step="0.1">
                    </div>
                </div>

                <div class="card" style="margin: 15px 0;">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>Material Costs</h4>
                            <button type="button" class="btn btn-primary" onclick="addMaterialCost()">+ Add Material</button>
                        </div>
                    </div>
                    <div class="card-body" id="materialCostsContainer">
                        ${materialCostsHtml}
                    </div>
                </div>

                <div class="card" style="margin: 15px 0;">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>Outsourced Costs</h4>
                            <button type="button" class="btn btn-primary" onclick="addOutsourcedCost()">+ Add Outsourced Cost</button>
                        </div>
                    </div>
                    <div class="card-body" id="outsourcedCostsContainer">
                        ${outsourcedCostsHtml}
                    </div>
                </div>

                <div class="form-group">
                    <label>Units Sold Monthly</label>
                    <input type="number" class="form-control" id="unitsSold" value="${isEditing ? product.sizes[0].unitsSoldMonthly : 0}" min="0">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-success" onclick="${isEditing ? `updateProduct(${product.id})` : 'saveNewProduct()'}">
                        ${isEditing ? 'Update Product' : 'Save Product'}
                    </button>
                    <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        function addMaterialCost() {
            const container = document.getElementById('materialCostsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'material-cost-item';
            newItem.setAttribute('data-index', materialCostIndex);
            newItem.innerHTML = `
                <div class="grid grid-3" style="align-items: end;">
                    <div class="form-group">
                        <label>Material Name</label>
                        <input type="text" class="form-control material-name" placeholder="e.g., Aluminum, Plastic">
                    </div>
                    <div class="form-group">
                        <label>Cost per kg (NOK)</label>
                        <input type="number" class="form-control material-cost" value="0" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger" onclick="removeMaterialCost(${materialCostIndex})">Remove</button>
                    </div>
                </div>
            `;
            container.appendChild(newItem);
            materialCostIndex++;
        }

        function removeMaterialCost(index) {
            const item = document.querySelector(`[data-index="${index}"].material-cost-item`);
            if (item) {
                item.remove();
            }
        }

        function addOutsourcedCost() {
            const container = document.getElementById('outsourcedCostsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'outsourced-cost-item';
            newItem.setAttribute('data-index', outsourcedCostIndex);
            newItem.innerHTML = `
                <div class="grid grid-3" style="align-items: end;">
                    <div class="form-group">
                        <label>Service Name</label>
                        <input type="text" class="form-control outsourced-name" placeholder="e.g., Assembly, Packaging">
                    </div>
                    <div class="form-group">
                        <label>Cost (NOK)</label>
                        <input type="number" class="form-control outsourced-cost" value="0" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger" onclick="removeOutsourcedCost(${outsourcedCostIndex})">Remove</button>
                    </div>
                </div>
            `;
            container.appendChild(newItem);
            outsourcedCostIndex++;
        }

        function removeOutsourcedCost(index) {
            const item = document.querySelector(`[data-index="${index}"].outsourced-cost-item`);
            if (item) {
                item.remove();
            }
        }

        function getProductFormData() {
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const wastePercentage = parseFloat(document.getElementById('wastePercentage').value) || 0;
            const grams = parseFloat(document.getElementById('sizeGrams').value) || 0;
            const profitMargin = parseFloat(document.getElementById('profitMargin').value) || 0;
            const unitsSoldMonthly = parseFloat(document.getElementById('unitsSold').value) || 0;

            const materialCosts = [];
            const materialItems = document.querySelectorAll('.material-cost-item');
            materialItems.forEach(item => {
                const nameInput = item.querySelector('.material-name');
                const costInput = item.querySelector('.material-cost');
                
                if (nameInput && costInput) {
                    const materialName = nameInput.value || 'Material';
                    const materialCost = parseFloat(costInput.value) || 0;
                    if (materialCost > 0) {
                        materialCosts.push({ name: materialName, costPerKg: materialCost });
                    }
                }
            });

            const outsourcedCosts = [];
            const outsourcedItems = document.querySelectorAll('.outsourced-cost-item');
            outsourcedItems.forEach(item => {
                const nameInput = item.querySelector('.outsourced-name');
                const costInput = item.querySelector('.outsourced-cost');
                
                if (nameInput && costInput) {
                    const outsourcedName = nameInput.value || 'Service';
                    const outsourcedCost = parseFloat(costInput.value) || 0;
                    if (outsourcedCost > 0) {
                        outsourcedCosts.push({ name: outsourcedName, cost: outsourcedCost });
                    }
                }
            });

            return {
                name,
                category,
                wastePercentage,
                sizes: [{
                    grams,
                    materialCosts,
                    outsourcedCosts,
                    profitMargin,
                    unitsSoldMonthly
                }]
            };
        }

        function saveNewProduct() {
            const productData = getProductFormData();
            if (productData.name && productData.category) {
                products.push({
                    id: Date.now(),
                    ...productData
                });
                updateProductsList();
                updateDashboard();
                autoSave();
                closeModal();
                
                materialCostIndex = 1;
                outsourcedCostIndex = 1;
            } else {
                alert('Please fill in product name and category');
            }
        }

        function updateProduct(productId) {
            const productData = getProductFormData();
            if (productData.name && productData.category) {
                const productIndex = products.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    products[productIndex] = {
                        id: productId,
                        ...productData
                    };
                    updateProductsList();
                    updateDashboard();
                    autoSave();
                    closeModal();
                    
                    materialCostIndex = 1;
                    outsourcedCostIndex = 1;
                }
            } else {
                alert('Please fill in product name and category');
            }
        }

        function updateProductsList() {
            const container = document.getElementById('productsList');
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 40px;">
                            <h3>No products added yet</h3>
                            <p>Click "Add Product" to get started!</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = products.map(product => {
                const metrics = calculateProductMetrics(product);
                const totalRevenue = metrics.reduce((sum, m) => sum + m.monthlySales, 0);
                const totalProfit = metrics.reduce((sum, m) => sum + m.monthlyProfit, 0);

                return `
                    <div class="product-item">
                        <div class="product-header">
                            <div>
                                <h4>${product.name}</h4>
                                <p>${product.category} • ${product.wastePercentage}% waste factor</p>
                            </div>
                            <div>
                                <button class="btn btn-warning" onclick="showEditProduct(${product.id})">Edit Product</button>
                                <button class="btn btn-primary" onclick="editProductUnits(${product.id})">Edit Sales</button>
                                <button class="btn btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                            </div>
                        </div>
                        <div class="grid grid-2">
                            <div>
                                <strong>Monthly Revenue:</strong> ${formatNOK(totalRevenue)}
                            </div>
                            <div>
                                <strong>Monthly Profit:</strong> ${formatNOK(totalProfit)}
                            </div>
                        </div>
                        
                        ${metrics[0].materialCosts && metrics[0].materialCosts.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <h5>Material Costs:</h5>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    ${metrics[0].materialCosts.map(material => `
                                        <span style="background: #e3f2fd; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                            ${material.name}: ${formatNOK(material.costPerKg)}/kg
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${metrics[0].outsourcedCosts && metrics[0].outsourcedCosts.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <h5>Outsourced Costs:</h5>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    ${metrics[0].outsourcedCosts.map(service => `
                                        <span style="background: #fff3e0; padding: 5px 10px; border-radius: 15px; font-size: 0.9em;">
                                            ${service.name}: ${formatNOK(service.cost)}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Size</th>
                                    <th>Material Cost</th>
                                    <th>Outsourced Cost</th>
                                    <th>Sales Price</th>
                                    <th>Profit/Unit</th>
                                    <th>Units Sold/Month</th>
                                    <th>Monthly Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${metrics.map(m => `
                                    <tr>
                                        <td>${m.grams}g</td>
                                        <td>${formatNOK(m.materialCost)}</td>
                                        <td>${formatNOK((m.outsourcedCosts ? m.outsourcedCosts.reduce((sum, s) => sum + s.cost, 0) : 0))}</td>
                                        <td>${formatNOK(m.salesPrice)}</td>
                                        <td>${formatNOK(m.profitPerUnit)}</td>
                                        <td><strong style="color: #1976d2;">${m.unitsSoldMonthly}</strong></td>
                                        <td>${formatNOK(m.monthlyProfit)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }

        function editProductUnits(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const metrics = calculateProductMetrics(product);
            
            const modal = createModal(`Edit Sales Data - ${product.name}`, `
                <p>Adjust the monthly units sold for each size of this product:</p>
                
                ${product.sizes.map((size, index) => {
                    const metric = metrics[index];
                    return `
                        <div class="card" style="margin-bottom: 15px;">
                            <div class="card-body">
                                <div class="grid grid-2">
                                    <div>
                                        <h5>${size.grams}g size</h5>
                                        <p><strong>Sales Price:</strong> ${formatNOK(metric.salesPrice)}</p>
                                        <p><strong>Profit per Unit:</strong> ${formatNOK(metric.profitPerUnit)}</p>
                                    </div>
                                    <div class="form-group">
                                        <label>Units Sold per Month</label>
                                        <input type="number" class="form-control units-input" 
                                               data-size-index="${index}" 
                                               data-profit-per-unit="${metric.profitPerUnit}"
                                               value="${size.unitsSoldMonthly}" 
                                               min="0" 
                                               oninput="updateProfitPreview(${index}, this.value, ${metric.profitPerUnit})"
                                               style="font-size: 1.1em; font-weight: bold;">
                                        <small style="color: #666;">
                                            Monthly Profit: <span id="profit-preview-${index}">${formatNOK(metric.monthlyProfit)}</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveProductUnits(${productId})">Save Changes</button>
                    <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        function updateProfitPreview(sizeIndex, units, profitPerUnit) {
            const newProfit = (parseFloat(units) || 0) * profitPerUnit;
            const previewElement = document.getElementById('profit-preview-' + sizeIndex);
            if (previewElement) {
                previewElement.textContent = formatNOK(newProfit);
            }
        }

        function saveProductUnits(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const inputs = document.querySelectorAll('.units-input');
            inputs.forEach(input => {
                const sizeIndex = parseInt(input.getAttribute('data-size-index'));
                const newUnits = parseFloat(input.value) || 0;
                product.sizes[sizeIndex].unitsSoldMonthly = newUnits;
            });

            updateProductsList();
            updateDashboard();
            autoSave();
            closeModal();
        }

        function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(p => p.id !== id);
                updateProductsList();
                updateDashboard();
                autoSave();
            }
        }

        // Company costs functions
        function showAddEmployee() {
            const modal = createModal('Add Employee', `
                <div class="grid grid-3">
                    <div class="form-group">
                        <label>Employee Name/Role</label>
                        <input type="text" class="form-control" id="empName" placeholder="e.g., John Doe - Manager">
                    </div>
                    <div class="form-group">
                        <label>Monthly Salary (NOK)</label>
                        <input type="number" class="form-control" id="empSalary" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Benefits/Month (NOK)</label>
                        <input type="number" class="form-control" id="empBenefits" value="0" min="0">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveEmployee()">Add Employee</button>
                    <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        function saveEmployee() {
            const name = document.getElementById('empName').value;
            const salary = parseFloat(document.getElementById('empSalary').value) || 0;
            const benefits = parseFloat(document.getElementById('empBenefits').value) || 0;

            if (name && salary) {
                companyCosts.employees.push({
                    id: Date.now(),
                    name,
                    monthlySalary: salary,
                    benefits
                });
                updateCompanyCosts();
                updateDashboard();
                autoSave();
                closeModal();
            } else {
                alert('Please fill in name and salary');
            }
        }

        function showAddFixedCost() {
            const modal = createModal('Add Fixed Cost', `
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Cost Description</label>
                        <input type="text" class="form-control" id="fixedName" placeholder="e.g., Rent, Insurance">
                    </div>
                    <div class="form-group">
                        <label>Monthly Amount (NOK)</label>
                        <input type="number" class="form-control" id="fixedAmount" value="0" min="0">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveFixedCost()">Add Fixed Cost</button>
                    <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        function saveFixedCost() {
            const name = document.getElementById('fixedName').value;
            const amount = parseFloat(document.getElementById('fixedAmount').value) || 0;

            if (name && amount) {
                companyCosts.fixedCosts.push({
                    id: Date.now(),
                    name,
                    monthlyAmount: amount
                });
                updateCompanyCosts();
                updateDashboard();
                autoSave();
                closeModal();
            } else {
                alert('Please fill in all fields');
            }
        }

        function showAddVariableCost() {
            const modal = createModal('Add Variable Cost', `
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Cost Description</label>
                        <input type="text" class="form-control" id="variableName" placeholder="e.g., Payment Processing">
                    </div>
                    <div class="form-group">
                        <label>Percentage of Revenue (%)</label>
                        <input type="number" class="form-control" id="variablePercent" value="0" min="0" max="100" step="0.1">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveVariableCost()">Add Variable Cost</button>
                    <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        function saveVariableCost() {
            const name = document.getElementById('variableName').value;
            const percentage = parseFloat(document.getElementById('variablePercent').value) || 0;

            if (name && percentage) {
                companyCosts.variableCosts.push({
                    id: Date.now(),
                    name,
                    percentageOfRevenue: percentage
                });
                updateCompanyCosts();
                updateDashboard();
                autoSave();
                closeModal();
            } else {
                alert('Please fill in all fields');
            }
        }

        function updateCompanyCosts() {
            const employeesList = document.getElementById('employeesList');
            if (companyCosts.employees.length === 0) {
                employeesList.innerHTML = '<p>No employees added yet</p>';
            } else {
                employeesList.innerHTML = companyCosts.employees.map(emp => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <div>
                            <strong>${emp.name}</strong><br>
                            <small>Salary: ${formatNOK(emp.monthlySalary)} + Benefits: ${formatNOK(emp.benefits || 0)}</small>
                        </div>
                        <div>
                            <strong>${formatNOK(emp.monthlySalary + (emp.benefits || 0))}/month</strong>
                            <button class="btn btn-danger" onclick="deleteEmployee(${emp.id})" style="margin-left: 10px;">Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            const fixedCostsList = document.getElementById('fixedCostsList');
            if (companyCosts.fixedCosts.length === 0) {
                fixedCostsList.innerHTML = '<p>No fixed costs added yet</p>';
            } else {
                fixedCostsList.innerHTML = companyCosts.fixedCosts.map(cost => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <strong>${cost.name}</strong>
                        <div>
                            <strong>${formatNOK(cost.monthlyAmount)}/month</strong>
                            <button class="btn btn-danger" onclick="deleteFixedCost(${cost.id})" style="margin-left: 10px;">Delete</button>
                        </div>
                    </div>
                `).join('');
            }

            const variableCostsList = document.getElementById('variableCostsList');
            if (companyCosts.variableCosts.length === 0) {
                variableCostsList.innerHTML = '<p>No variable costs added yet</p>';
            } else {
                variableCostsList.innerHTML = companyCosts.variableCosts.map(cost => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <strong>${cost.name}</strong>
                        <div>
                            <strong>${cost.percentageOfRevenue}% of revenue</strong>
                            <button class="btn btn-danger" onclick="deleteVariableCost(${cost.id})" style="margin-left: 10px;">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function deleteEmployee(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                companyCosts.employees = companyCosts.employees.filter(e => e.id !== id);
                updateCompanyCosts();
                updateDashboard();
                autoSave();
            }
        }

        function deleteFixedCost(id) {
            if (confirm('Are you sure you want to delete this fixed cost?')) {
                companyCosts.fixedCosts = companyCosts.fixedCosts.filter(c => c.id !== id);
                updateCompanyCosts();
                updateDashboard();
                autoSave();
            }
        }

        function deleteVariableCost(id) {
            if (confirm('Are you sure you want to delete this variable cost?')) {
                companyCosts.variableCosts = companyCosts.variableCosts.filter(c => c.id !== id);
                updateCompanyCosts();
                updateDashboard();
                autoSave();
            }
        }

        // Export functions
        function exportToCSV() {
            const data = ['Product,Category,Monthly Sales,Monthly Profit'];
            products.forEach(product => {
                const metrics = calculateProductMetrics(product);
                const totalSales = metrics.reduce((sum, m) => sum + m.monthlySales, 0);
                const totalProfit = metrics.reduce((sum, m) => sum + m.monthlyProfit, 0);
                data.push(`${product.name},${product.category},${totalSales},${totalProfit}`);
            });
            
            downloadFile(data.join('\n'), `products-${new Date().toISOString().slice(0, 10)}.csv`, 'text/csv');
        }

        function exportForPowerPoint() {
            alert('Export for PowerPoint feature would open a new window with formatted charts');
        }

        // Data management functions
        function updateDataStatus() {
            document.getElementById('productCount').textContent = products.length;
            document.getElementById('employeeCount').textContent = companyCosts.employees.length;
            document.getElementById('lastSaved').textContent = new Date().toLocaleString('nb-NO');
        }

        function exportBackup() {
            const data = {
                products: products,
                companyCosts: companyCosts,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            downloadFile(dataStr, `backup-${new Date().toISOString().slice(0, 10)}.json`, 'application/json');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (importedData.products) products = importedData.products;
                        if (importedData.companyCosts) companyCosts = importedData.companyCosts;
                        
                        updateProductsList();
                        updateCompanyCosts();
                        updateDashboard();
                        updateDataStatus();
                        saveData(true);
                        
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                products = [];
                companyCosts = { employees: [], fixedCosts: [], variableCosts: [] };
                
                updateProductsList();
                updateCompanyCosts();
                updateDashboard();
                updateDataStatus();
                
                updateSaveStatus('Data Cleared');
            }
        }

        // Utility functions
        function createModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 style="margin-bottom: 20px;">${title}</h3>
                    ${content}
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>